{% extends "base.html" %}
{% block content %}

<div class="add-page">
  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
    <div>
      <h2 class="text-white mb-1">Add Taster</h2>
      <p class="text-white mb-0">Select a class in the week grid, then add taster details.</p>
    </div>
    <div class="btn-group">
      <a href="{{ url_for('add', programme='lockwood', week_start=week_start.isoformat()) }}"
          class="btn btn-sm {% if programme=='lockwood' %}btn-green{% else %}btn-glass{% endif %}">
        Lockwood
      </a>
      <a href="{{ url_for('add', programme='honley', week_start=week_start.isoformat()) }}"
          class="btn btn-sm {% if programme=='honley' %}btn-green{% else %}btn-glass{% endif %}">
        Honley
      </a>
      <a href="{{ url_for('add', programme='preschool', week_start=week_start.isoformat()) }}"
          class="btn btn-sm {% if programme=='preschool' %}btn-green{% else %}btn-glass{% endif %}">
        Preschool
      </a>
    </div>
  </div>

  <div id="weekPickerWrap">
    <div class="add-week-controls mb-3">
      <a href="{{ url_for('add', programme=programme, week_start=prev_week) }}" class="btn btn-glass btn-sm">← Prev</a>
      <a href="{{ url_for('add', programme=programme, week_start=today_str) }}" class="btn btn-glass btn-sm">Today</a>
      <span class="add-week-label">{{ week_start.strftime('%d %b %Y') }} - {{ week_end.strftime('%d %b %Y') }}</span>
      <a href="{{ url_for('add', programme=programme, week_start=next_week) }}" class="btn btn-glass btn-sm">Next →</a>
    </div>

    <div class="add-week-grid mb-3">
    {% for day in week_days %}
    <section class="add-day-column {% if day.date_str == today_str %}is-today{% endif %}">
      <header class="add-day-header">
        <div class="add-day-name">{{ day.day_name }}</div>
        <div class="add-day-date">{{ day.date_obj.strftime('%d %b %Y') }}</div>
        {% if day.date_str == today_str %}
        <div class="add-day-today-badge">Today</div>
        {% endif %}
      </header>
      <div class="add-day-body">
        {% if day.sessions %}
          {% for s in day.sessions %}
          <button type="button"
                  class="session-tile"
                  data-date="{{ day.date_str }}"
                  data-session="{{ s.session_value }}"
                  data-class-name="{{ s.class_name }}"
                  data-time="{{ s.time_range }}">
            <div class="session-tile-title">{{ s.class_name }}</div>
            <div class="session-tile-time">{{ s.time_range }}</div>
            <div class="session-tile-type">{{ s.class_type }}</div>
            <div class="session-tile-chip">Upcoming: {{ s.upcoming_count }}</div>
          </button>
          {% endfor %}
        {% else %}
          <div class="session-empty">No classes for this day</div>
        {% endif %}
      </div>
    </section>
    {% endfor %}
    </div>
  </div>

  <a href="{{ url_for('add_manual_taster', programme=programme, week_start=week_start.isoformat()) }}" class="btn btn-glass mb-3">
    Add Manual Session (Separate Screen)
  </a>

  <div id="addTasterPanel" class="card-form add-taster-panel d-none">
    <div class="selected-session-box mb-3">
      <div id="selectedSessionTitle" class="selected-session-title">Select a class to begin</div>
      <div id="selectedSessionMeta" class="selected-session-meta">No class selected yet</div>
    </div>

    <form method="post">
      {{ csrf_field() }}
      <input type="hidden" name="session" id="sessionValueInput">
      <input type="hidden" name="class_name" id="classNameInput">

      <div class="mb-3">
        <label class="form-label">Child Name</label>
        <input name="child" class="form-control" required>
      </div>

      <div class="mb-3">
        <label class="form-label">Taster Date</label>
        <input id="sessionDateInput" type="date" name="taster_date" class="form-control" required>
      </div>

      <div class="mb-3">
        <label class="form-label">Notes (Optional)</label>
        <textarea name="notes" class="form-control" rows="2"></textarea>
      </div>

      <button class="btn btn-green w-100">Save Taster</button>
    </form>
  </div>
</div>

<script>
const panel = document.getElementById("addTasterPanel");
const weekPickerWrap = document.getElementById("weekPickerWrap");
const tiles = Array.from(document.querySelectorAll(".session-tile"));
const sessionValueInput = document.getElementById("sessionValueInput");
const classNameInput = document.getElementById("classNameInput");
const sessionDateInput = document.getElementById("sessionDateInput");
const selectedTitle = document.getElementById("selectedSessionTitle");
const selectedMeta = document.getElementById("selectedSessionMeta");

function showPanel() {
  panel.classList.remove("d-none");
}

function selectClass(tile) {
  const dateStr = tile.dataset.date;
  const session = tile.dataset.session;
  const className = tile.dataset.className;
  const timeRange = tile.dataset.time;

  showPanel();
  weekPickerWrap.classList.add("d-none");
  sessionValueInput.value = session;
  classNameInput.value = className;
  sessionDateInput.value = dateStr;
  sessionDateInput.readOnly = true;

  selectedTitle.textContent = className;
  selectedMeta.textContent = `${dateStr} • ${timeRange}`;

  tiles.forEach((t) => t.classList.remove("active"));
  tile.classList.add("active");
}

tiles.forEach((tile) => {
  tile.addEventListener("click", () => selectClass(tile));
});
</script>

{% endblock %}
