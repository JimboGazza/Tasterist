{% extends "base.html" %}
{% block content %}

<div class="container-fluid import-page">
  <div class="import-header mb-4">
    <h1 class="text-white mb-1">Data Import</h1>
    <p class="text-muted mb-0">
      Internal DB is primary. Upload workbook updates, then run import when needed.
    </p>
  </div>

  <div class="import-card mb-4">
    <div class="import-card-body">
      <h5 class="mb-2">Storage Status</h5>
      <div class="import-meta">
        <span class="import-meta-item">DB File: <strong>{{ storage_stats.db_file }}</strong></span>
        <span class="import-meta-item">DB Exists: <strong>{{ "Yes" if storage_stats.db_exists else "No" }}</strong></span>
        <span class="import-meta-item">Accounts: <strong>{{ storage_stats.user_count }}</strong></span>
        <span class="import-meta-item">Tasters: <strong>{{ storage_stats.taster_count }}</strong></span>
        <span class="import-meta-item">Leavers: <strong>{{ storage_stats.leaver_count }}</strong></span>
      </div>
      <div class="import-meta mt-2">
        <span class="import-meta-item">Import Folder: <strong>{{ storage_stats.import_source }}</strong></span>
        <span class="import-meta-item">Folder Exists: <strong>{{ "Yes" if storage_stats.import_source_exists else "No" }}</strong></span>
        <span class="import-meta-item">Workbook Files: <strong>{{ storage_stats.xlsx_count }}</strong></span>
      </div>
      <div class="mt-3 d-flex gap-2 flex-wrap">
        <a href="{{ url_for('all_tasters') }}" class="btn btn-glass btn-sm">Edit DB (Find Taster)</a>
        <a href="{{ url_for('admin_tasks') }}" class="btn btn-glass btn-sm">Admin Tasks</a>
      </div>
    </div>
  </div>

  <div class="import-card mb-4">
    <div class="import-card-body">
      <h5 class="mb-2">Upload Workbook Updates</h5>
      <p class="text-muted small mb-3">
        Upload local `.xlsx` copies here. If files are still cloud placeholders (OneDrive not fully downloaded), Safari may fail the upload.
      </p>
      {% if is_admin_user %}
      <form method="post" action="{{ url_for('import_upload') }}" enctype="multipart/form-data">
        {{ csrf_field() }}
        <input type="file" name="workbooks" class="form-control mb-3" accept=".xlsx" multiple required>
        <label class="form-check mb-3">
          <input class="form-check-input" type="checkbox" name="run_after_upload" value="1" checked>
          <span class="form-check-label">Run full import after upload</span>
        </label>
        {% if destructive_imports_enabled %}
        <label class="form-check mb-3">
          <input class="form-check-input" type="checkbox" name="replace_all" value="1">
          <span class="form-check-label">Replace all existing tasters/leavers (danger)</span>
        </label>
        {% else %}
        <div class="alert alert-dark small mb-3">
          Replace-all import is disabled for safety in this environment.
        </div>
        {% endif %}
        <button type="submit" class="btn btn-green w-100">Upload Workbook Files</button>
      </form>
      {% else %}
      <div class="alert alert-dark mb-0">Only admin-level accounts can upload/import workbooks.</div>
      {% endif %}
    </div>
  </div>

  <div class="import-card mb-4">
    <div class="import-card-body">
      <h5 class="mb-2">Run Full Import</h5>
      <p class="text-muted small mb-3">
        Reads supported `.xlsx` files and refreshes tasters/leavers in the internal DB.
        <br>
        <strong>Policy:</strong> 2025 always uses local archived copies; 2026+ uses OneDrive files first with fallback.
      </p>
      <p class="small mb-3">
        <code>{{ import_source }}</code>
      </p>
      <div class="import-file-tags mb-4">
        <span class="import-tag">Lockwood</span>
        <span class="import-tag">Honley</span>
        <span class="import-tag">Preschool</span>
        <span class="import-tag">2025 + 2026</span>
      </div>
      {% if is_admin_user %}
      <form method="post" action="{{ url_for('import_run') }}">
        {{ csrf_field() }}
        {% if destructive_imports_enabled %}
        <label class="form-check mb-3">
          <input class="form-check-input" type="checkbox" name="replace_all" value="1">
          <span class="form-check-label">Replace all existing tasters/leavers (danger)</span>
        </label>
        {% else %}
        <div class="alert alert-dark small mb-3">
          Replace-all import is disabled for safety in this environment.
        </div>
        {% endif %}
        <button type="submit" class="btn btn-green btn-lg w-100 import-run-btn">
          Run Import Now
        </button>
      </form>
      {% else %}
      <div class="alert alert-dark mb-0">Only admin-level accounts can run imports.</div>
      {% endif %}
    </div>
  </div>

  {% if last_import %}
  <div class="import-card mb-4">
    <div class="import-card-body">
      <div class="import-log-head mb-3">
        <h5 class="mb-2">Last Import</h5>
        <div class="import-meta">
          <span class="import-meta-item">
            Run at: <strong>{{ last_import.run_at|uk_datetime }}</strong>
          </span>
          {% if last_import.exit_code is not none %}
          <span class="import-meta-item">
            Status:
            <strong class="{{ 'text-success' if last_import.exit_code == 0 else 'text-warning' }}">
              {{ "Success" if last_import.exit_code == 0 else "Needs Review" }}
            </strong>
          </span>
          {% endif %}
          <span class="import-meta-item">
            Files: <strong>{{ last_import.files_processed }}</strong>
          </span>
          <span class="import-meta-item">
            Warnings: <strong>{{ last_import.warnings | length }}</strong>
          </span>
        </div>
      </div>

      <div class="import-stats mb-3">
        <div class="import-stat-box">
          <div class="import-stat-label">Tasters Imported</div>
          <div class="import-stat-value">{{ last_import.total_tasters if last_import.total_tasters is not none else "—" }}</div>
        </div>
        <div class="import-stat-box">
          <div class="import-stat-label">Leavers Imported</div>
          <div class="import-stat-value">{{ last_import.total_leavers if last_import.total_leavers is not none else "—" }}</div>
        </div>
        <div class="import-stat-box">
          <div class="import-stat-label">Files Processed</div>
          <div class="import-stat-value">{{ last_import.files_processed }}</div>
        </div>
      </div>

      {% if last_import.warnings %}
      <div class="import-warning-list mb-3">
        {% for warning in last_import.warnings %}
        <div class="import-warning-item">{{ warning }}</div>
        {% endfor %}
      </div>
      {% endif %}

      <details class="import-log-details">
        <summary>View Full Log</summary>
        <pre class="import-log-pre">{{ last_import.log_text }}</pre>
      </details>
    </div>
  </div>
  {% endif %}

  <div class="import-note small">
    <strong>Note:</strong> import is idempotent for existing records. Review warnings and summary before re-running.
  </div>
</div>

{% endblock %}
