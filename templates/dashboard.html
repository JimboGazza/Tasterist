{% extends "base.html" %}
{% block content %}

<div class="container-fluid dashboard-page">
  <div class="dashboard-top mb-4">
    <div>
      <h1 class="mb-1 text-white">Hi {{ (current_user.full_name or current_user.username).split(' ')[0] }}</h1>
      <p class="text-white mb-0">{{ month }}</p>
    </div>
    <div class="dashboard-top-right">
      <div class="d-flex gap-2">
        <a href="{{ url_for('month') }}" class="btn btn-glass">Month</a>
        <a href="{{ url_for('stats') }}" class="btn btn-glass">Stats</a>
        <a href="{{ url_for('account_settings') }}" class="btn btn-green">Settings</a>
      </div>
    </div>
  </div>

  <div class="dashboard-metrics mb-4">
    <section class="dashboard-card">
      <p class="dashboard-label">Tasters This Month</p>
      <div class="dashboard-value">{{ tasters }}</div>
    </section>
    <section class="dashboard-card">
      <p class="dashboard-label">Leavers This Month</p>
      <div class="dashboard-value">{{ leavers }}</div>
    </section>
    <section class="dashboard-card">
      <p class="dashboard-label">Net Movement</p>
      <div class="dashboard-value {% if net < 0 %}text-danger{% endif %}">
        {% if net >= 0 %}+{% endif %}{{ net }}
      </div>
      <p class="dashboard-subtle mb-0">{{ days_left }} days left this month</p>
    </section>
    <section class="dashboard-card">
      <p class="dashboard-label">Open Follow-ups</p>
      <div class="dashboard-value">{{ followups_open }}</div>
      <p class="dashboard-subtle mb-0">From last ~2 months</p>
    </section>
    <section class="dashboard-card">
      <p class="dashboard-label">Tasters To Members</p>
      <div class="dashboard-value">{{ converted_month }}</div>
      <p class="dashboard-subtle mb-0">This month complete checks</p>
    </section>
    <section class="dashboard-card">
      <p class="dashboard-label">This Week Bookings</p>
      <div class="dashboard-value">{{ week_bookings }}</div>
      <p class="dashboard-subtle mb-0">{{ week_start.strftime('%d %b') }} - {{ week_end.strftime('%d %b') }}</p>
    </section>
  </div>

  <section class="dashboard-card dashboard-today-hub mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
      <h3 class="mb-0">Today's Tasters</h3>
      <div class="dashboard-pills">
        <span class="dashboard-pill">{{ today.strftime('%A %d %B') }}</span>
        <span class="dashboard-pill">Total: {{ todays_total }}</span>
      </div>
    </div>
    <div class="today-programme-grid">
      {% for key, label in [('lockwood','Lockwood'), ('honley','Honley'), ('preschool','Preschool')] %}
      <section class="today-programme-col">
        <header class="today-programme-head">
          <span class="today-programme-name">{{ label }}</span>
          <span class="dashboard-chip">{{ todays_counts[key] }}</span>
        </header>
        <div class="today-programme-body">
          {% if todays_by_programme[key] %}
            {% for t in todays_by_programme[key] %}
            <div class="today-taster-row">
              <div class="today-taster-name">{{ t.child }}</div>
              <div class="today-taster-meta">
                {{ t.session or "Session TBD" }}
                {% if t.class_name %} • {{ t.class_name }}{% endif %}
              </div>
            </div>
            {% endfor %}
          {% else %}
            <div class="task-empty">No tasters today.</div>
          {% endif %}
        </div>
      </section>
      {% endfor %}
    </div>
  </section>

  <div class="dashboard-secondary-grid">
    <section class="dashboard-card">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">This Month By Programme</h5>
        <span class="dashboard-subtle">Live totals</span>
      </div>
      <div class="dashboard-programme-list">
        {% for row in month_by_programme %}
        <div class="dashboard-programme-row">
          <div class="dashboard-programme-head">
            <span class="dashboard-programme-name">{{ row.label }}</span>
            <span class="dashboard-programme-count">{{ row.count }}</span>
          </div>
          <div class="dashboard-programme-bar-track">
            <div class="dashboard-programme-bar-fill" style="width: {{ row.pct }}%;"></div>
          </div>
        </div>
        {% endfor %}
      </div>
    </section>

    <div class="dashboard-right-stack">
      <section class="dashboard-card">
        <div class="quick-actions-head mb-3">
          <h5 class="mb-0">Quick Actions</h5>
          <div class="dashboard-clock dashboard-clock-mini">
            <div class="dashboard-label mb-0">Time</div>
            <div id="dashClock" class="dashboard-clock-value">{{ current_time }}</div>
          </div>
        </div>
        <div class="d-grid gap-2">
          <a href="{{ url_for('add') }}" class="btn btn-green">Add Taster</a>
          <a href="{{ url_for('add_leaver') }}" class="btn btn-glass">Record Leaver</a>
          <a href="{{ url_for('admin_tasks') }}" class="btn btn-glass">Open Admin Tasks</a>
        </div>
      </section>

      <section class="dashboard-card monitor-card">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
          <h5 class="mb-0">Monitor</h5>
          <div class="d-flex gap-2 align-items-center">
            {% if is_admin_user %}
            <a href="{{ url_for('cloud_preflight') }}" class="btn btn-glass btn-sm">Cloud Preflight</a>
            {% endif %}
            <span class="monitor-pill {{ monitor.class_name }}">{{ monitor.label }}</span>
          </div>
        </div>
        <div class="dashboard-pills">
          <span class="dashboard-pill">Last Import: {{ monitor.run_at }}</span>
          <span class="dashboard-pill">Warnings: {{ monitor.warnings }}</span>
          <span class="dashboard-pill">Import Tasters: {{ monitor.import_total_tasters if monitor.import_total_tasters is not none else "—" }}</span>
          <span class="dashboard-pill">DB Tasters: {{ monitor.db_total_tasters }}</span>
        </div>
      </section>
    </div>
  </div>
</div>

<script>
const clockEl = document.getElementById("dashClock");
function tickClock() {
  const now = new Date();
  const hh = String(now.getHours()).padStart(2, "0");
  const mm = String(now.getMinutes()).padStart(2, "0");
  const ss = String(now.getSeconds()).padStart(2, "0");
  clockEl.textContent = `${hh}:${mm}:${ss}`;
}
tickClock();
setInterval(tickClock, 1000);
</script>

{% endblock %}
