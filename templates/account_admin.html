{% extends "base.html" %}
{% block content %}

<div class="container-fluid account-admin-page">
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
    <div>
      <h2 class="text-white mb-1">Admin Console</h2>
      <p class="text-muted mb-0">Manage accounts and review audit logs (owner only).</p>
    </div>
    <div class="d-flex gap-2 flex-wrap">
      <a href="{{ url_for('import_page') }}" class="btn btn-green btn-sm">
        <i class="bi bi-database-up nav-ico"></i> Import Centre
      </a>
      <a href="{{ url_for('account_settings') }}" class="btn btn-glass btn-sm">Back to Settings</a>
    </div>
  </div>

  <div class="dashboard-card mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
      <div>
        <h5 class="mb-1">Account Management</h5>
        <p class="dashboard-subtle mb-0">Edit profile details, role, password, admin-day ownership, or remove accounts.</p>
      </div>
      <button class="btn btn-green btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#createAccountPanel" aria-expanded="false" aria-controls="createAccountPanel">
        <i class="bi bi-person-plus nav-ico"></i> Create Account
      </button>
    </div>

    <div class="collapse account-create-panel mb-3" id="createAccountPanel">
      <form method="post" class="account-admin-form">
        {{ csrf_field() }}
        <input type="hidden" name="action" value="create_user">
        <div class="account-admin-fields">
          <div>
            <label class="form-label">Full Name</label>
            <input name="full_name" class="form-control" required>
          </div>
          <div>
            <label class="form-label">Email</label>
            <input name="username" type="email" class="form-control" required>
          </div>
          <div>
            <label class="form-label">Role</label>
            <select name="role" class="form-select">
              <option value="staff" selected>Staff</option>
              <option value="admin">Admin</option>
            </select>
          </div>
        </div>
        <p class="dashboard-subtle mb-2">
          New accounts get a unique temporary password and must change it at first sign-in.
        </p>

        <div class="dashboard-label mt-2 mb-2">Admin Day Ownership (Optional)</div>
        <div class="admin-days-grid mb-3">
          <div class="admin-days-head"></div>
          <div class="admin-days-head">Preschool</div>
          <div class="admin-days-head">Honley</div>
          <div class="admin-days-head">Lockwood</div>
          {% for row in grouped_options %}
            <div class="admin-days-day">{{ row.day_name }}</div>
            {% for cell in row.cells %}
              {% if cell.visible %}
              <label class="admin-days-cell admin-days-btn">
                <input class="admin-days-input" type="checkbox" name="admin_days" value="{{ cell.value }}">
                <span class="admin-days-hit"></span>
              </label>
              {% else %}
              <span class="admin-days-empty" aria-hidden="true"></span>
              {% endif %}
            {% endfor %}
          {% endfor %}
        </div>

        <button type="submit" class="btn btn-green btn-sm">Create Account</button>
      </form>
    </div>

    <div class="account-admin-users">
      {% for u in users %}
      {% set selected_set = assignment_map.get(u.id, []) %}
      <details class="account-admin-user">
        <summary class="account-admin-summary">
          <div>
            <div class="account-admin-name">{{ u.full_name or "Unnamed User" }}</div>
            <div class="dashboard-subtle">{{ u.username }} â€¢ Created {{ u.created_at }}</div>
          </div>
          <div class="d-flex align-items-center gap-2">
            <span class="account-admin-pass {% if u.password_must_change %}is-temp{% else %}is-changed{% endif %}">
              {% if u.password_must_change %}Temporary Password Active{% else %}Password Updated{% endif %}
            </span>
            <span class="account-admin-role {% if u.role == 'owner' %}is-owner{% elif u.role == 'admin' %}is-admin{% else %}is-staff{% endif %}">
              {{ u.role|title }}
            </span>
            <i class="bi bi-chevron-down account-admin-chevron"></i>
          </div>
        </summary>
        <div class="account-admin-body">
          <form method="post" class="account-admin-form">
            {{ csrf_field() }}
            <input type="hidden" name="action" value="save_user">
            <input type="hidden" name="user_id" value="{{ u.id }}">

            <div class="account-admin-fields">
              <div>
                <label class="form-label">Full Name</label>
                <input name="full_name" class="form-control" value="{{ u.full_name }}" required>
              </div>
              <div>
                <label class="form-label">Email</label>
                <input name="username" type="email" class="form-control" value="{{ u.username }}" required>
              </div>
              <div>
                <label class="form-label">Role</label>
                <select name="role" class="form-select" {% if u.role == "owner" %}disabled{% endif %}>
                  <option value="staff" {% if u.role == "staff" %}selected{% endif %}>Staff</option>
                  <option value="admin" {% if u.role == "admin" %}selected{% endif %}>Admin</option>
                  <option value="owner" {% if u.role == "owner" %}selected{% endif %} disabled>Owner</option>
                </select>
                {% if u.role == "owner" %}
                <input type="hidden" name="role" value="owner">
                {% endif %}
              </div>
              <div>
                <label class="form-label">Set New Password</label>
                <input name="new_password" type="password" class="form-control" placeholder="Leave blank to keep">
              </div>
            </div>

            <div class="dashboard-label mt-2 mb-2">Admin Day Ownership</div>
            <div class="admin-days-grid mb-3">
              <div class="admin-days-head"></div>
              <div class="admin-days-head">Preschool</div>
              <div class="admin-days-head">Honley</div>
              <div class="admin-days-head">Lockwood</div>
              {% for row in grouped_options %}
                <div class="admin-days-day">{{ row.day_name }}</div>
                {% for cell in row.cells %}
                  {% if cell.visible %}
                  <label class="admin-days-cell admin-days-btn">
                    <input class="admin-days-input" type="checkbox" name="admin_days" value="{{ cell.value }}" {% if cell.value in selected_set %}checked{% endif %}>
                    <span class="admin-days-hit"></span>
                  </label>
                  {% else %}
                  <span class="admin-days-empty" aria-hidden="true"></span>
                  {% endif %}
                {% endfor %}
              {% endfor %}
            </div>

            <button type="submit" class="btn btn-green btn-sm">Save Account</button>
          </form>

          <form method="post" class="account-admin-danger" onsubmit="return confirm('Remove this account? This cannot be undone.');">
            {{ csrf_field() }}
            <input type="hidden" name="action" value="delete_user">
            <input type="hidden" name="user_id" value="{{ u.id }}">
            <button type="submit" class="btn btn-danger-soft btn-sm" {% if u.role == 'owner' %}disabled{% endif %}>
              Remove Account
            </button>
          </form>
        </div>
      </details>
      {% endfor %}
    </div>
  </div>

  <div class="dashboard-card mb-4">
    <div class="d-flex justify-content-between align-items-center gap-2 flex-wrap mb-2">
      <h5 class="mb-0">Weekly Email Reports</h5>
      <form method="post" action="{{ url_for('send_weekly_report_now') }}">
        {{ csrf_field() }}
        <button type="submit" class="btn btn-green btn-sm">Send Weekly Report Now</button>
      </form>
    </div>
    <div class="dashboard-pills">
      <span class="dashboard-pill">Email Enabled: {{ "Yes" if email_enabled else "No" }}</span>
      <span class="dashboard-pill">Webhook Configured: {{ "Yes" if email_webhook_configured else "No" }}</span>
      <span class="dashboard-pill">Owner-Only Mode: {{ "Yes" if email_owner_only else "No" }}</span>
      <span class="dashboard-pill">Recipient (current mode): {{ current_user.username }}</span>
    </div>
    <p class="dashboard-subtle mb-0 mt-2">
      Cloudflare cron can call <code>/cron/weekly-admin-report</code> using header <code>X-Tasterist-Cron-Token</code>.
    </p>
  </div>

  <div class="dashboard-card">
    <h5 class="mb-2">Action Logs</h5>
    <p class="dashboard-subtle mb-3">Latest 500 events from all accounts.</p>
    <div class="table-responsive">
      <table class="table table-dark table-striped table-sm mb-0 tasters-table">
        <thead>
          <tr>
            <th>Time</th>
            <th>User</th>
            <th>Action</th>
            <th>Entity</th>
            <th>Status</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
          {% for l in logs %}
          <tr>
            <td>{{ l.created_at }}</td>
            <td>{{ l.username }}</td>
            <td>{{ l.action }}</td>
            <td>{{ l.entity_type }} {{ l.entity_id }}</td>
            <td>{{ l.status }}</td>
            <td>{{ l.details }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{% endblock %}
