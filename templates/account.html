{% extends "base.html" %}
{% block content %}

<div class="form-page account-page">
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
    <h2 class="text-white mb-0">Account Settings</h2>
    {% if is_admin_user %}
    <a href="{{ url_for('account_admin') }}" class="btn btn-glass btn-sm">
      <i class="bi bi-shield-lock nav-ico"></i> Admin Console
    </a>
    {% endif %}
  </div>

  <div class="account-grid mb-4">
    <form method="post" class="card-form">
      <input type="hidden" name="action" value="profile">
      <h5 class="mb-3">Profile</h5>
      <div class="mb-3">
        <label class="form-label">First Name</label>
        <input name="first_name" class="form-control" value="{{ first_name }}" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Last Name</label>
        <input name="last_name" class="form-control" value="{{ last_name }}" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Email</label>
        <input name="email" type="email" class="form-control" value="{{ user.username }}" required>
      </div>
      <button type="submit" class="btn btn-green">Update Profile</button>
    </form>

    <form method="post" class="card-form account-admin-card">
      <input type="hidden" name="action" value="admin_days">
      <h5 class="mb-2">Admin Day Ownership</h5>
      {% if user.admin_days %}
      <div class="dashboard-pills mb-3">
        {% for a in user.admin_days %}
        <span class="dashboard-pill">{{ a.day_name }} • {{ a.programme|title }}</span>
        {% endfor %}
      </div>
      {% endif %}
      <p class="text-white mb-3">Set who owns each admin day/programme block.</p>
      <div class="admin-days-grid mb-3">
        <div class="admin-days-head"></div>
        <div class="admin-days-head">Preschool</div>
        <div class="admin-days-head">Honley</div>
        <div class="admin-days-head">Lockwood</div>
        {% for row in grouped_options %}
          <div class="admin-days-day">{{ row.day_name }}</div>
          {% for cell in row.cells %}
            <label class="admin-days-cell admin-days-btn">
              <input class="admin-days-input" type="checkbox" name="admin_days" value="{{ cell.value }}" {% if cell.value in selected_set %}checked{% endif %}>
              <span class="admin-days-hit"></span>
            </label>
          {% endfor %}
        {% endfor %}
      </div>
      <button type="submit" class="btn btn-green">Save Admin Days</button>
    </form>
  </div>

  <div class="account-grid mb-4">
    <form method="post" class="card-form">
      <input type="hidden" name="action" value="password">
      <h5 class="mb-3">Change Password</h5>
      <div class="mb-3">
        <label class="form-label">Current Password</label>
        <input type="password" name="current_password" class="form-control" required>
      </div>
      <div class="mb-3">
        <label class="form-label">New Password</label>
        <input type="password" name="new_password" class="form-control" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Confirm New Password</label>
        <input type="password" name="confirm_password" class="form-control" required>
      </div>
      <button type="submit" class="btn btn-green">Update Password</button>
    </form>

    <form method="post" class="dashboard-card">
      <input type="hidden" name="action" value="import_now">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
        <h5 class="mb-0">Data Import</h5>
        <div class="d-flex gap-2">
          <button type="submit" class="btn btn-green btn-sm">Run Import Now</button>
          <a href="{{ url_for('import_page') }}" class="btn btn-glass btn-sm">View Log</a>
        </div>
      </div>
      {% if last_import %}
        <div class="dashboard-subtle mb-1">Last run: {{ last_import.run_at }}</div>
        <div class="dashboard-pills">
          <span class="dashboard-pill">Files: {{ last_import.files_processed }}</span>
          <span class="dashboard-pill">Warnings: {{ last_import.warnings|length }}</span>
          <span class="dashboard-pill">Tasters: {{ last_import.total_tasters if last_import.total_tasters is not none else "—" }}</span>
        </div>
      {% else %}
        <p class="dashboard-subtle mb-0">No import run logged yet.</p>
      {% endif %}
    </form>
  </div>
</div>

{% endblock %}
