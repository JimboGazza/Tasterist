{% extends "base.html" %}
{% block content %}

<div class="form-page account-page">
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
    <h2 class="text-white mb-0">Account Settings</h2>
    <div class="d-flex gap-2">
      {% if is_owner_user %}
      <a href="{{ url_for('account_admin') }}" class="btn btn-glass btn-sm">
        <i class="bi bi-shield-lock nav-ico"></i> Admin Console
      </a>
      {% endif %}
      {% if is_admin_user %}
      <a href="{{ url_for('import_page') }}" class="btn btn-green btn-sm">
        <i class="bi bi-database-up nav-ico"></i> Import Centre
      </a>
      <a href="{{ url_for('cloud_preflight') }}" class="btn btn-glass btn-sm">
        <i class="bi bi-cloud-check nav-ico"></i> Cloud Preflight
      </a>
      {% endif %}
    </div>
  </div>

  <div class="account-grid mb-4">
    <form method="post" class="card-form">
      {{ csrf_field() }}
      <input type="hidden" name="action" value="profile">
      <h5 class="mb-3">Profile</h5>
      <div class="mb-3">
        <label class="form-label">First Name</label>
        <input name="first_name" class="form-control" value="{{ first_name }}" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Last Name</label>
        <input name="last_name" class="form-control" value="{{ last_name }}" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Email</label>
        <input name="email" type="email" class="form-control" value="{{ user.username }}" required>
      </div>
      <button type="submit" class="btn btn-green">Update Profile</button>
    </form>

    <form method="post" class="card-form account-admin-card">
      {{ csrf_field() }}
      <input type="hidden" name="action" value="admin_days">
      <h5 class="mb-2">Admin Day Ownership</h5>
      {% if user.admin_days %}
      <div class="dashboard-pills mb-3">
        {% for a in user.admin_days %}
        <span class="dashboard-pill">{{ a.day_name }} â€¢ {{ a.programme|title }}</span>
        {% endfor %}
      </div>
      {% endif %}
      <p class="text-white mb-3">Set who owns each admin day/programme block.</p>
      <div class="admin-days-grid mb-3">
        <div class="admin-days-head"></div>
        <div class="admin-days-head">Preschool</div>
        <div class="admin-days-head">Honley</div>
        <div class="admin-days-head">Lockwood</div>
        {% for row in grouped_options %}
          <div class="admin-days-day">{{ row.day_name }}</div>
          {% for cell in row.cells %}
            {% if cell.visible %}
            <label class="admin-days-cell admin-days-btn">
              <input class="admin-days-input" type="checkbox" name="admin_days" value="{{ cell.value }}" {% if cell.value in selected_set %}checked{% endif %}>
              <span class="admin-days-hit"></span>
            </label>
            {% else %}
            <span class="admin-days-empty" aria-hidden="true"></span>
            {% endif %}
          {% endfor %}
        {% endfor %}
      </div>
      <button type="submit" class="btn btn-green">Save Admin Days</button>
    </form>
  </div>

  <div class="account-grid mb-4">
    <form method="post" class="card-form">
      {{ csrf_field() }}
      <input type="hidden" name="action" value="password">
      <h5 class="mb-3">Change Password</h5>
      <div class="mb-3">
        <label class="form-label">Current Password</label>
        <input type="password" name="current_password" class="form-control" required>
      </div>
      <div class="mb-3">
        <label class="form-label">New Password</label>
        <input type="password" name="new_password" class="form-control" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Confirm New Password</label>
        <input type="password" name="confirm_password" class="form-control" required>
      </div>
      <button type="submit" class="btn btn-green">Update Password</button>
    </form>
    <form method="post" class="dashboard-card">
      {{ csrf_field() }}
      <input type="hidden" name="action" value="email_prefs">
      <h5 class="mb-2">Email Preferences</h5>
      <label class="form-check mb-2">
        <input class="form-check-input" type="checkbox" name="weekly_report_opt_in" value="1" {% if weekly_report_opt_in %}checked{% endif %}>
        <span class="form-check-label">Receive weekly admin summary emails</span>
      </label>
      {% if email_owner_only_mode and not is_owner_user %}
      <p class="dashboard-subtle mb-2">Owner-only mode is active, so weekly reports currently only send to the owner account.</p>
      {% endif %}
      <button type="submit" class="btn btn-green btn-sm">Save Email Preferences</button>
    </form>
  </div>

  <div class="account-grid mb-4">
    <div class="dashboard-card">
      <h5 class="mb-2">Import Management</h5>
      <p class="dashboard-subtle mb-2">Workbook uploads, imports, and app-entry exports are managed in Import Centre.</p>
      {% if is_admin_user %}
      <div class="d-flex gap-2 flex-wrap">
        <a href="{{ url_for('import_page') }}" class="btn btn-glass btn-sm">
          <i class="bi bi-database-up nav-ico"></i> Open Import Centre
        </a>
        <a href="{{ url_for('export_app_added_tasters_csv') }}" class="btn btn-glass btn-sm">
          <i class="bi bi-download nav-ico"></i> Export App Tasters (CSV)
        </a>
      </div>
      {% else %}
      <p class="dashboard-subtle mb-0">Ask an admin to run imports/exports.</p>
      {% endif %}
    </div>
  </div>
</div>

{% endblock %}
