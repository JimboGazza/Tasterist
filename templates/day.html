{% extends "base.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
  <a class="btn btn-glass btn-sm"
      href="{{ url_for('month',
        y=selected_date.year,
        m=selected_date.month,
        programme=programme) }}">
      ‚Üê Back to month
  </a>
  <div class="btn-group">
    <a href="{{ url_for('day_detail', date_str=selected_date.isoformat(), programme='lockwood') }}"
        class="btn btn-sm {% if programme=='lockwood' %}btn-green{% else %}btn-glass{% endif %}">
      Lockwood
    </a>
    <a href="{{ url_for('day_detail', date_str=selected_date.isoformat(), programme='honley') }}"
        class="btn btn-sm {% if programme=='honley' %}btn-green{% else %}btn-glass{% endif %}">
      Honley
    </a>
    <a href="{{ url_for('day_detail', date_str=selected_date.isoformat(), programme='preschool') }}"
        class="btn btn-sm {% if programme=='preschool' %}btn-green{% else %}btn-glass{% endif %}">
      Preschool
    </a>
  </div>
</div>

<div class="day-title-wrap mb-4">
  <h1 class="day-title-main mb-0">{{ selected_date.strftime('%A %d %B %Y') }}</h1>
  <div class="day-nav-row">
    <a class="btn btn-glass btn-sm day-nav-btn" href="{{ url_for('day_detail', date_str=prev_date.isoformat(), programme=programme) }}">Prev</a>
    <a class="btn btn-glass btn-sm day-nav-btn" href="{{ url_for('day_detail', date_str=today_date.isoformat(), programme=programme) }}">Today</a>
    <a class="btn btn-glass btn-sm day-nav-btn" href="{{ url_for('day_detail', date_str=next_date.isoformat(), programme=programme) }}">Next</a>
  </div>
</div>

{% if data.empty %}
  <div class="day-empty-state">
    <div class="alert alert-dark border">
      {% if selected_date == today_date %}
      No tasters today!
      {% else %}
      No tasters booked for this day.
      {% endif %}
    </div>
  </div>
{% else %}

  {% for session, rows in data.groupby('session') %}
  <div class="day-session mb-4">

    <!-- SESSION HEADER -->
    <div class="session-header">
      {{ session or selected_date.strftime('%A') }}
    </div>

    <div class="day-session-body">

      {% for r in rows.itertuples() %}
      <div class="day-row">

        <!-- LEFT -->
        <div class="day-info">
          <div class="day-name">{{ r.child }}</div>
          {% if r.notes %}
            <div class="day-notes">{{ r.notes }}</div>
          {% endif %}
        </div>

        <!-- RIGHT -->
        <div class="day-actions">

          <form method="post" action="{{ url_for('toggle', taster_id=r.id, field='attended') }}">
            {{ csrf_field() }}
            <button class="toggle-btn attended {% if r.attended %}active{% endif %}">
              Attended
            </button>
          </form>

          <form method="post" action="{{ url_for('toggle', taster_id=r.id, field='club_fees') }}">
            {{ csrf_field() }}
            <button class="toggle-btn club-fees {% if r.club_fees %}active{% endif %}">
              Club Fees
            </button>
          </form>

          <form method="post" action="{{ url_for('toggle', taster_id=r.id, field='bg') }}">
            {{ csrf_field() }}
            <button class="toggle-btn bg {% if r.bg %}active{% endif %}">
              BG
            </button>
          </form>

          <form method="post" action="{{ url_for('toggle', taster_id=r.id, field='badge') }}">
            {{ csrf_field() }}
            <button class="toggle-btn badge {% if r.badge %}active{% endif %}">
              Badge
            </button>
          </form>

        </div>

      </div>
      {% endfor %}

    </div>
  </div>
  {% endfor %}

  <div class="day-bottom-grid mt-4">
    <section class="dashboard-card day-summary-card">
      <h5 class="mb-3">Day Snapshot</h5>
      <div class="day-kpi-grid">
        <div class="day-kpi">
          <div class="day-kpi-label">Total</div>
          <div class="day-kpi-value">{{ day_stats.total }}</div>
        </div>
        <div class="day-kpi">
          <div class="day-kpi-label">To Action</div>
          <div class="day-kpi-value is-warn">{{ day_stats.to_action }}</div>
        </div>
        <div class="day-kpi">
          <div class="day-kpi-label">Fully Complete</div>
          <div class="day-kpi-value is-good">{{ day_stats.fully_complete }}</div>
        </div>
      </div>
      <div class="day-checkline mt-3">
        <span>Attended {{ day_stats.attended }}/{{ day_stats.total }}</span>
        <span>Club Fees {{ day_stats.club_fees }}/{{ day_stats.total }}</span>
        <span>BG {{ day_stats.bg }}/{{ day_stats.total }}</span>
        <span>Badge {{ day_stats.badge }}/{{ day_stats.total }}</span>
      </div>
    </section>

    <section class="dashboard-card day-progress-card">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">Session Progress</h5>
        <span class="dashboard-chip">{{ day_stats.completion_pct }}% complete</span>
      </div>
      <div class="day-progress-list">
        {% for s in session_totals %}
        <div class="day-progress-row">
          <div class="day-progress-head">
            <span class="day-progress-name">{{ s.label }}</span>
            <span class="day-progress-count">{{ s.complete }}/{{ s.total }} complete</span>
          </div>
          <div class="day-progress-bar-track">
            <div class="day-progress-bar-fill" style="width: {{ s.pct }}%;"></div>
          </div>
          {% if s.to_action > 0 %}
          <div class="day-progress-note">{{ s.to_action }} to action</div>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    </section>
  </div>

{% endif %}

{% endblock %}
