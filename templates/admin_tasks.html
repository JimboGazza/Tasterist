{% extends "base.html" %}
{% block content %}

<div class="container-fluid admin-tasks-page">
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
    <div>
      <h2 class="text-white mb-1">Admin Tasks</h2>
      <p class="text-white mb-0">Follow-ups from {{ cutoff }} to {{ today }}.</p>
    </div>
    <a href="{{ url_for('account_settings') }}" class="btn btn-glass">Edit Admin Days</a>
  </div>

  {% if has_custom_assignments %}
  <div class="dashboard-card mb-3">
    <p class="dashboard-label">Your Admin Days</p>
    <div class="dashboard-pills">
      {% for a in assignments %}
      <span class="dashboard-pill">{{ a.day_name }} • {{ a.programme|title }}</span>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <div class="dashboard-card mb-3">
    <h5 class="mb-2">Leavers Totals ({{ month_label }})</h5>
    <div class="dashboard-pills">
      {% if summary_rows %}
        {% for row in summary_rows %}
        <span class="dashboard-pill">
          {{ row.day_name }} • {{ row.programme|title }}: {{ row.leavers }}
        </span>
        {% endfor %}
      {% else %}
        <span class="dashboard-pill">No leaver totals yet.</span>
      {% endif %}
      {% for u in unknown_summary %}
      <span class="dashboard-pill">? • {{ u.programme|title }}: {{ u.count }}</span>
      {% endfor %}
    </div>
  </div>

  <div class="dashboard-card mb-4">
    <h5 class="mb-2">Tasters To Members ({{ month_label }})</h5>
    <p class="dashboard-subtle mb-2">Attended + paid club fees + BG + badge all complete.</p>
    <div class="dashboard-pills">
      {% if summary_rows %}
        {% for row in summary_rows %}
        <span class="dashboard-pill">
          {{ row.day_name }} • {{ row.programme|title }}: {{ row.members }}
        </span>
        {% endfor %}
      {% else %}
        <span class="dashboard-pill">No conversion totals yet.</span>
      {% endif %}
    </div>
  </div>

  <div class="dashboard-card">
    <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
      <h5 class="mb-0">Unified Follow-ups</h5>
      <span class="dashboard-chip">{{ followup_total }} rows</span>
    </div>
    <p class="dashboard-subtle mb-3">One list for no-shows and incomplete checks.</p>

    {% if followup_rows %}
    <div class="followup-list">
      {% for t in followup_rows %}
      <div class="followup-row">
        <div class="followup-main">
          <div class="task-row-name">{{ t.child }}</div>
          <div class="dashboard-subtle">
            {{ t.taster_date }} • {{ t.day_name }} • {{ t.programme|title }}
            {% if t.class_name %} • {{ t.class_name }}{% endif %}
            {% if t.session %} • {{ t.session }}{% endif %}
          </div>
        </div>
        <div class="followup-actions">
          <form method="post" action="{{ url_for('toggle', taster_id=t.id, field='attended') }}">
            <button class="toggle-btn attended {% if t.attended %}active{% endif %}">
              Attended
            </button>
          </form>

          {% if t.attended %}
          <button class="toggle-btn contact disabled" disabled>Contacted</button>
          {% else %}
          <form method="post" action="{{ url_for('admin_mark_contacted', taster_id=t.id) }}">
            <button class="toggle-btn contact {% if t.reschedule_contacted %}active{% endif %}">
              {% if t.reschedule_contacted %}Contacted{% else %}Contact{% endif %}
            </button>
          </form>
          {% endif %}

          <form method="post" action="{{ url_for('toggle', taster_id=t.id, field='club_fees') }}">
            <button class="toggle-btn club-fees {% if t.club_fees %}active{% endif %}">
              Club Fees
            </button>
          </form>

          <form method="post" action="{{ url_for('toggle', taster_id=t.id, field='bg') }}">
            <button class="toggle-btn bg {% if t.bg %}active{% endif %}">
              BG
            </button>
          </form>

          <form method="post" action="{{ url_for('toggle', taster_id=t.id, field='badge') }}">
            <button class="toggle-btn badge {% if t.badge %}active{% endif %}">
              Badge
            </button>
          </form>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="task-empty">No follow-ups right now.</div>
    {% endif %}
  </div>
</div>

{% endblock %}
