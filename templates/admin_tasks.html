{% extends "base.html" %}
{% block content %}

<div class="container-fluid admin-tasks-page">
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
    <div>
      <h2 class="text-white mb-1">Admin Tasks</h2>
      <p class="text-white mb-0">Follow-ups from {{ cutoff|uk_date }} to {{ today|uk_date }}.</p>
    </div>
    <a href="{{ url_for('account_settings') }}" class="btn btn-glass">Edit Admin Days</a>
  </div>

  {% set leavers_total = summary_rows | sum(attribute='leavers') %}
  {% set members_total = summary_rows | sum(attribute='members') %}

  <div class="dashboard-card mb-3">
    <p class="dashboard-label">Active Filters</p>
    {% if has_custom_assignments %}
    <div class="admin-filter-grid">
      {% for a in assignments %}
      <a class="admin-filter-box" href="{{ url_for('account_settings') }}" title="Edit filters in Account Settings">
        <span class="admin-filter-check" aria-hidden="true">
          <i class="bi bi-check2"></i>
        </span>
        <span class="admin-filter-label">{{ a.day_name }} • {{ a.programme|title }}</span>
      </a>
      {% endfor %}
    </div>
    <p class="dashboard-subtle mb-0 mt-2">Admin Tasks is filtered to these day/programme blocks. Click a box to edit filters.</p>
    {% else %}
    <div class="task-empty mb-0">No admin-day filter set. Showing all programmes and days.</div>
    {% endif %}
  </div>

  <div class="admin-totals-grid mb-4">
    <div class="dashboard-card admin-total-card is-leavers">
      <div class="admin-total-head">
        <div>
          <p class="dashboard-label mb-1">Leavers ({{ month_label }})</p>
          <p class="dashboard-subtle mb-0">Leavers due on your admin days.</p>
        </div>
        <div class="admin-total-value">{{ leavers_total }}</div>
      </div>
      <div class="admin-total-breakdown">
        {% if summary_rows %}
          {% for row in summary_rows %}
          <div class="admin-total-item">
            <span>{{ row.day_name }} • {{ row.programme|title }}</span>
            <strong>{{ row.leavers }}</strong>
          </div>
          {% endfor %}
        {% else %}
          <div class="admin-total-item is-empty">No leaver totals yet.</div>
        {% endif %}
        {% for u in unknown_summary %}
        <div class="admin-total-item unknown">
          <span>? • {{ u.programme|title }}</span>
          <strong>{{ u.count }}</strong>
        </div>
        {% endfor %}
      </div>
    </div>

    <div class="dashboard-card admin-total-card is-members">
      <div class="admin-total-head">
        <div>
          <p class="dashboard-label mb-1">Tasters To Members ({{ month_label }})</p>
          <p class="dashboard-subtle mb-0">Attended + club fees + BG + badge complete.</p>
        </div>
        <div class="admin-total-value">{{ members_total }}</div>
      </div>
      <div class="admin-total-breakdown">
        {% if summary_rows %}
          {% for row in summary_rows %}
          <div class="admin-total-item">
            <span>{{ row.day_name }} • {{ row.programme|title }}</span>
            <strong>{{ row.members }}</strong>
          </div>
          {% endfor %}
        {% else %}
          <div class="admin-total-item is-empty">No conversion totals yet.</div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="dashboard-card admin-followup-card">
    <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
      <h5 class="mb-0">To Action</h5>
      <span class="dashboard-chip">{{ followup_total }} rows</span>
    </div>
    <p class="dashboard-subtle mb-3">Follow up no-shows and incomplete checks.</p>

    <div class="followup-scroll">
      {% if followup_rows %}
      <div class="followup-list">
        {% for t in followup_rows %}
        <div class="followup-row">
          <div class="followup-main">
            <div class="task-row-name">{{ t.child }}</div>
            <div class="dashboard-subtle">
              {{ t.taster_date|uk_date }} • {{ t.day_name }} • {{ t.programme|title }}
              {% if t.class_name %} • {{ t.class_name }}{% endif %}
              {% if t.session %} • {{ t.session }}{% endif %}
            </div>
          </div>
          <div class="followup-actions">
            <form method="post" action="{{ url_for('toggle', taster_id=t.id, field='attended') }}">
              {{ csrf_field() }}
              <button class="toggle-btn attended {% if t.attended %}active{% endif %}">
                Attended
              </button>
            </form>

            {% if t.attended %}
            <button class="toggle-btn contact disabled" disabled>Contacted</button>
            {% else %}
            <form method="post" action="{{ url_for('admin_mark_contacted', taster_id=t.id) }}">
              {{ csrf_field() }}
              <button class="toggle-btn contact {% if t.reschedule_contacted %}active{% endif %}">
                {% if t.reschedule_contacted %}Contacted{% else %}Contact{% endif %}
              </button>
            </form>
            {% endif %}

            <form method="post" action="{{ url_for('toggle', taster_id=t.id, field='club_fees') }}">
              {{ csrf_field() }}
              <button class="toggle-btn club-fees {% if t.club_fees %}active{% endif %}">
                Club Fees
              </button>
            </form>

            <form method="post" action="{{ url_for('toggle', taster_id=t.id, field='bg') }}">
              {{ csrf_field() }}
              <button class="toggle-btn bg {% if t.bg %}active{% endif %}">
                BG
              </button>
            </form>

            <form method="post" action="{{ url_for('toggle', taster_id=t.id, field='badge') }}">
              {{ csrf_field() }}
              <button class="toggle-btn badge {% if t.badge %}active{% endif %}">
                Badge
              </button>
            </form>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="task-empty">No follow-ups right now.</div>
      {% endif %}
    </div>
  </div>
</div>

{% endblock %}
